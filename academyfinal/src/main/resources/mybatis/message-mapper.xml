<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="messageList">

	<!-- 등록 -->
	<select id="sequence" resultType="long">
		select message_seq.nextval from dual
	</select>
	<insert id="add">
		insert into message(
			message_no, message_type, message_content,
			message_time, message_sender, message_receiver
		)
		values(
			#{messageNo}, #{messageType}, #{messageContent},
			#{messageTime}, #{messageSender}, #{messageReceiver}
		)
	</insert>
	
	<!-- 메시지 조회 -->
	<select id="list" resultType="MessageViewDto">
		select * from message_view
		where message_type in ('CAHT', 'SYSTEM')
		order by message_no asc
	</select>
	
	<!--일정 개수만큼 메시지 조회-->
	<select id="listByPaging" resultType="MessageViewDto">
		select * from (
			<include refid = "top-n-header"></include>
				select * from message_view
				where message_type in ('CHAT','SYSTEM')
				<if test="messageNo != null">
					<![CDATA[
						and message_no < #{messageNo}
					]]>
				</if>
				order by message_no desc
			<include refid="top-n-footer"></include>
		 ) order by message_no asc
	</select>
	
	<!--남은 데이터 개수 확인-->
	<select id="cntByPaging" resultType="int">
		select count(*) from message_view
		where message_type in ('CHAT', 'SYSTEM')
		<if test="messagNo != null">
			<![CDATA[
				and message_no < #{messageNo}
			]]>
		</if>
	</select>
	
	<!-- Top N Query 템플릿 -->
	<sql id="top-n-header">
		select * from (
			select rownum rn, TMP.* from (
	</sql>
	<sql id="top-n-footer">
			) TMP
		) where rn between 1 and 10
	</sql>
	
</mapper>
